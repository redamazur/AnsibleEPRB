---
- hosts: devbdd
  become: true
  
  vars:
    mysql_user_home: /root
    mysql_user_name: root
    mysql_user_password: root
    mysql_root_password_update: false
    mysql_enabled_on_startup: true

  
  tasks:
    - name: Update apt-get repo and cache
      apt: update_cache=yes force_apt_get=yes
    - name: Upgrade the OS (apt-get dist-upgrade)
      apt:
        upgrade: dist


    - name: Installation mysql-server
      apt:
        name: mysql-server

    - name: Update mysql root password for all root accounts
      mysql_user: name=root password=root



    - name: Download initial SQL file
      get_url:
        url: https://raw.githubusercontent.com/brichbourg/Multi-Tier-App-Demo/master/sql/create_db_table.sql
        dest: .

    - name: execute install.sh
      shell:
         cmd: mysql -u root -p root

    - name: Simple select query to appdemo db
      community.mysql.mysql_query:
      login_db: 
      login_user: root
      login_password: root
      query: 
        - CREATE TABLE `demodata` (  `id` INTEGER NOT NULL AUTO_INCREMENT,  `name` VARCHAR(100),  `notes` TEXT,  `timestamp` TIMESTAMP,  PRIMARY KEY (`id`),  KEY (`name`)  )
        - CREATE TABLE `demodata_erase_log` (  `id` INTEGER NOT NULL AUTO_INCREMENT,  `timestamp` TIMESTAMP,  PRIMARY KEY (`id`),  KEY (`timestamp`)  )
        - CREATE USER 'appdemo'@'%' IDENTIFIED BY 'appdemo'
        - GRANT ALL PRIVILEGES ON appdemo.* to 'appdemo'@'%' WITH GRANT OPTION




  
    - name: execute install.sh
      shell:
         cmd: /bin/bash install.sh
      args:
        chdir: ./Multi-Tier-App-Demo/




         
    - name: Reload Apache 2
      service:
        name: apache2
        state: reloaded   
